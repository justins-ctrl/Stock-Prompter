<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Trade Prompter</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  background:#0e1117; color:#e6e6e6; padding:20px;
}
h1 { text-align:center; margin-bottom:10px; }
input, select, button {
  width:100%; padding:14px; margin-top:10px;
  border-radius:10px; border:none; font-size:16px;
}
input, select { background:#161b22; color:white; }
button { background:#2563eb; color:white; font-weight:bold; }
.card {
  background:#161b22; padding:16px; margin-top:14px; border-radius:14px;
}
.good { color:#22c55e; }
.warn { color:#facc15; }
.bad { color:#ef4444; }
.bullish { color:#22c55e; }
.bearish { color:#ef4444; }
.neutral { color:#9ca3af; }
small { color:#9ca3af; }
.banner {
  border-radius:12px; padding:12px; margin-bottom:10px;
}
.banner.good { background:#052e1a; }
.banner.warn { background:#3a2a00; }
.banner.bad  { background:#3a0b0b; }
</style>
</head>

<body>

<h1>ðŸ“ˆ Trade Prompter</h1>

<div id="context"></div>

<input id="tickerInput" placeholder="Ticker (AAPL, TSLA, SPY)" />
<select id="strategy">
  <option value="scalp">Scalp (0â€“1 days)</option>
  <option value="weekly">Weekly Options</option>
  <option value="biweekly">Bi-Weekly Options</option>
</select>
<input id="accountSize" placeholder="Account size (e.g. 5000)" />
<label style="display:block;margin-top:10px;">
  <input type="checkbox" id="alertsOn" checked /> Alerts ON (soft-warn labeled)
</label>
<button onclick="runScan()">Analyze</button>

<div id="results"></div>

<script>
let lastAlert = "";

// ---------- TIME / SESSION ----------
function sessionInfo() {
  const d = new Date();
  const h = d.getHours(), m = d.getMinutes();
  if (h < 9 || (h === 9 && m < 30)) return "Premarket";
  if (h === 9 && m <= 35) return "Open";
  if (h < 11) return "Morning";
  if (h < 15) return "Midday";
  if (h < 16) return "Power Hour";
  return "Closed";
}
function marketOpen() {
  const s = sessionInfo();
  return ["Open","Morning","Midday","Power Hour"].includes(s);
}

// ---------- DATA ----------
async function fetchPrices(ticker, range="1d", interval="5m") {
  const url = `https://corsproxy.io/?https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?range=${range}&interval=${interval}`;
  const r = await fetch(url);
  const j = await r.json();
  const q = j.chart.result[0].indicators.quote[0];
  return { prices: q.close.filter(Boolean), volumes: q.volume.filter(Boolean) };
}

// ---------- INDICATORS ----------
function rsi(prices, p=14) {
  let g=0,l=0;
  for (let i=prices.length-p;i<prices.length-1;i++) {
    const d=prices[i+1]-prices[i];
    d>=0?g+=d:l-=d;
  }
  const rs=g/(l||1);
  return 100-(100/(1+rs));
}

// ---------- MARKET CONTEXT (SOFT WARN) ----------
async function marketContext() {
  const { prices } = await fetchPrices("SPY");
  const open = prices[0], last = prices.at(-1);
  const change = ((last-open)/open)*100;
  const r = rsi(prices);

  let score = 0;
  // Trend strength
  if (Math.abs(change) > 0.4) score += 1;
  if (Math.abs(change) > 0.8) score += 1;

  // Volatility proxy
  if (r < 40 || r > 60) score += 1;

  // Time-of-day
  const s = sessionInfo();
  if (["Open","Morning","Power Hour"].includes(s)) score += 1;
  if (s === "Midday") score -= 1;

  let level = "warn";
  let label = "âš ï¸ Market Context: Caution";
  if (score >= 3) { level="good"; label="âœ… Market Context: Favorable"; }
  if (score <= 0) { level="bad";  label="â›” Market Context: Poor"; }

  document.getElementById("context").innerHTML = `
    <div class="banner ${level}">
      <strong>${label}</strong><br>
      SPY change: ${change.toFixed(2)}% â€¢ RSI: ${r.toFixed(1)} â€¢ Session: ${s}
    </div>
  `;
  return { level, score };
}

// ---------- OPTION IDEA ----------
function optionIdea(price, change, rsiVal, strategy, account, contextLevel) {
  let bias="WAIT";
  if (change>0.4 && rsiVal<70) bias="CALL";
  if (change<-0.4 && rsiVal>30) bias="PUT";

  let confidence = Math.min(100, Math.abs(change)*40 + (50-Math.abs(50-rsiVal)));
  if (contextLevel !== "good") confidence *= 0.85; // de-weight on soft-warn

  let expiration = strategy==="biweekly"?"Bi-Weekly":(strategy==="weekly"?"Weekly":"0â€“1D");
  let risk = account>25000?"Large":account>10000?"Medium":"Small";

  return { bias, confidence, expiration, risk };
}

// ---------- MAIN ----------
async function runScan() {
  const t = document.getElementById("tickerInput").value.trim().toUpperCase();
  if (!t) return;
  const strategy = document.getElementById("strategy").value;
  const acct = Number(document.getElementById("accountSize").value||5000);
  const alertsOn = document.getElementById("alertsOn").checked;
  const results = document.getElementById("results");

  results.innerHTML = `<div class="card">Scanning ${t}â€¦</div>`;

  try {
    const ctx = await marketContext();
    const { prices } = await fetchPrices(t);
    const cur = prices.at(-1), op = prices[0];
    const ch = ((cur-op)/op)*100;
    const r = rsi(prices);

    const opt = optionIdea(cur, ch, r, strategy, acct, ctx.level);

    let cls="neutral";
    if (opt.bias==="CALL") cls="bullish";
    if (opt.bias==="PUT") cls="bearish";

    const label = ctx.level==="good" ? "" : " âš ï¸ LOW CONTEXT";
    const msg = `${t}: ${opt.bias} ${opt.expiration}${label}`;

    if (alertsOn && marketOpen() && opt.confidence>65 && msg!==lastAlert) {
      lastAlert = msg;
      alert(msg);
      if ("Notification" in window && Notification.permission==="granted") {
        new Notification("Trade Prompter", { body: msg });
      }
    }

    results.innerHTML = `
      <div class="card">
        <strong>${t}</strong><br>
        Price: $${cur.toFixed(2)} (${ch.toFixed(2)}%)<br>
        RSI: ${r.toFixed(1)}<br><br>
        <span class="${cls}"><strong>${opt.bias} ${opt.expiration}</strong></span><br>
        Confidence: ${opt.confidence.toFixed(0)}%<br>
        Suggested Risk: ${opt.risk}
      </div>
    `;
  } catch {
    results.innerHTML = `<div class="card">Error loading data</div>`;
  }
}

if ("Notification" in window) Notification.requestPermission();
setInterval(runScan, 120000);
</script>

</body>
</html>
